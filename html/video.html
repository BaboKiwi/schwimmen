<html>
    <head>
        <title>Schwimmen Online - Video</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="jquery-3.5.1.js"></script>
        <script src='https://meet.jit.si/external_api.js'></script>
        <script src='base64.js'></script>	
        <script src='crypto-js.min.js'></script>	
        <style> 
            #video{
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="video"></div>
        <script>
            var url_string = window.location.href
            var url = new URL(url_string);
            var name = url.searchParams.get("name");
            var room = url.searchParams.get("room");
            console.log("Room '" + room + "', name: '" + name + "'");
            var configOverwrite = {
                defaultLanguage: 'de',
//                    minParticipants: 1,
//                    disableInviteFunctions: true,
//                    prejoinPageEnabled: false
            };

            var options = {
                roomName: room,
                width: "100%",
                height: "100%",
                parentNode: document.querySelector('#video'),
                configOverwrite: configOverwrite,
//                jwt: getJWT(room, name),
//                userInfo: {displayName: 'John Doe'},
                interfaceConfigOverwrite: {
                    HIDE_INVITE_MORE_HEADER: true,
                    filmStripOnly: false,
                    MOBILE_APP_PROMO: true,
//                    VERTICAL_FILMSTRIP: false,
//                    FILM_STRIP_MAX_HEIGHT: "12em"
                }
            };

            if (name !== undefined && name !== null && name !== 'null') {
                options.userInfo = {displayName: name};
                configOverwrite.prejoinPageEnabled = false;
            }

            var jitsiApi = new JitsiMeetExternalAPI('meet.jit.si', options);

            // Event:  videoConferenceJoined
            // Event: videoConferenceLeft

            function getJWT(room, name) {
                var expDate = (Date.now() / 1000) + (60 * 60 * 24);  // 24h
                var header = {
                    "typ": "JWT",
                    "alg": "HS256"
                }
                var payload = {
                    "context": {
                        "user": {
//                            "avatar": "https:/gravatar.com/avatar/abc123",
//                            "email": "jdoe@example.com",
                            "name": name
                        }
                    },
                    "sub": "meet.jit.si",
                    "room": room,
                    "exp": expDate
                }
                var secret = "sharedSecret";
                header = JSON.stringify(header);
                payload = JSON.stringify(payload);
                var token = base64url_encode(header) + "." + base64url_encode(payload);
                var signature = CryptoJS.HmacSHA256(token, secret);
                signature = base64url_encode(signature);
                return token + "." + signature;
            }

            $(document).ready(function () {
                window.addEventListener('unload', function (event) {
                    jitsiApi.dispose();
                });
            });
        </script>    
    </body>
</html>
